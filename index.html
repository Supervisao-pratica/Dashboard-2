<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel BI - Supervisão Senac 2025</title>
    <!-- Bibliotecas Externas (CDNs) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        :root {
            --senac-blue: #004587;
            --senac-orange: #f68d2e;
            --senac-light-blue: #0056a3;
        }

        /* Classes Utilitárias Senac */
        .text-senac-blue { color: var(--senac-blue); }
        .text-senac-orange { color: var(--senac-orange); }
        .bg-senac-blue { background-color: var(--senac-blue); }
        .bg-senac-orange { background-color: var(--senac-orange); }
        
        .card-bi { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); 
            border: 1px solid #e2e8f0; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-bi:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Botões de Alternância de Escopo */
        .scope-btn {
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            opacity: 0.6;
            cursor: pointer;
        }
        .scope-btn.active {
            opacity: 1;
            border-bottom-color: var(--senac-orange);
            background-color: #f8fafc;
            color: var(--senac-blue);
        }

        /* Animações */
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Loader */
        .loader { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #f68d2e; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Estilo para inputs financeiros */
        .money-input {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 600;
            color: #0f172a;
            width: 100%;
            transition: all 0.2s;
        }
        .money-input:focus {
            border-color: var(--senac-blue);
            outline: none;
            background: white;
            box-shadow: 0 0 0 3px rgba(0, 69, 135, 0.1);
        }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- TELA DE LOGIN (Página Inteira) -->
    <div id="loginPage" class="fixed inset-0 z-[100] flex items-center justify-center bg-slate-100">
        <!-- Background decorativo -->
        <div class="absolute inset-0 overflow-hidden">
            <div class="absolute -top-[20%] -left-[10%] w-[50%] h-[50%] rounded-full bg-senac-blue/5 blur-3xl"></div>
            <div class="absolute top-[60%] -right-[10%] w-[40%] h-[60%] rounded-full bg-senac-orange/5 blur-3xl"></div>
        </div>

        <div class="bg-white rounded-2xl shadow-xl border border-slate-200 w-full max-w-md p-8 relative overflow-hidden z-10 mx-4">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-senac-blue to-senac-orange"></div>
            
            <div class="text-center mb-8">
                <img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Senac_logo.svg" alt="Senac Logo" class="h-16 mx-auto mb-4">
                <h2 class="text-2xl font-extrabold text-senac-blue">Portal do Supervisor</h2>
                <p class="text-sm text-slate-500 mt-1">Validação de Segurança</p>
            </div>

            <!-- Formulário de Login -->
            <div id="loginForm">
                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Região de Atuação</label>
                        <div class="relative">
                            <select id="loginRegion" onchange="toggleLoginMethod()" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-medium outline-none focus:border-senac-blue focus:ring-2 focus:ring-blue-50 appearance-none cursor-pointer">
                                <option value="">Acesso Geral (Todas as Regiões)</option>
                                <!-- Regiões populadas via JS -->
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>

                    <div id="emailContainer" class="hidden animate-fade-in">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Seu E-mail Corporativo</label>
                        <div class="relative">
                            <input type="email" id="loginEmail" placeholder="nome.sobrenome@senac.br" 
                                class="w-full p-3 pl-10 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-medium outline-none focus:border-senac-blue focus:ring-2 focus:ring-blue-50">
                            <i data-lucide="mail" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>

                    <div id="passwordContainer" class="animate-fade-in">
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Senha de Acesso</label>
                        <div class="relative">
                            <input type="password" id="loginPassword" placeholder="Digite a senha de gestão" 
                                class="w-full p-3 pl-10 pr-10 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-medium outline-none focus:border-senac-blue focus:ring-2 focus:ring-blue-50">
                            <i data-lucide="lock" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>
                
                <button onclick="performLogin()" class="w-full py-3 bg-senac-blue hover:bg-blue-800 text-white font-bold rounded-xl transition-all shadow-lg shadow-blue-900/10 flex items-center justify-center gap-2">
                    <span>Acessar Painel</span>
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>

                 <div class="mt-6 flex justify-center items-center px-2">
                    <button onclick="resetUsersToDefault()" class="text-[10px] text-slate-400 hover:text-red-500 hover:underline">
                        Restaurar Padrão
                    </button>
                </div>
            </div>
        </div>
        
        <div class="absolute bottom-4 text-slate-400 text-xs text-center w-full">
            &copy; 2025 Senac PR - Gerência de Educação e Tecnologia
        </div>
    </div>

    <!-- ÁREA PRINCIPAL DO SISTEMA (Inicialmente Oculta) -->
    <div id="appContainer" class="hidden flex-col h-screen w-full">
        
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 flex-shrink-0 z-30 shadow-sm flex flex-col">
            <!-- Top Bar -->
            <div class="h-16 flex items-center justify-between px-8">
                <div class="flex items-center gap-4">
                    <div class="flex flex-col select-none justify-center">
                        <img src="https://upload.wikimedia.org/wikipedia/commons/8/86/Senac_logo.svg" alt="Senac" class="h-10">
                    </div>
                    <div class="h-8 w-px bg-slate-200 mx-2"></div>
                    <div>
                        <h1 class="font-bold text-sm text-slate-700">Painel de Supervisão</h1>
                        <p class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">Gestão de Aprendizagem</p>
                    </div>
                </div>

                <div class="flex items-center gap-6">
                    <!-- Info Usuário -->
                    <div class="text-right hidden md:block">
                        <p class="text-sm font-bold text-senac-blue" id="displayUserName"></p>
                        <p class="text-[10px] text-slate-400 font-mono" id="displayUserRegion"></p>
                    </div>

                    <!-- Botão Upload -->
                    <div class="flex items-center gap-2">
                        <input type="file" id="fileInput" accept=".csv, .xlsx, .xlsm, .xls" class="hidden" onchange="processFile(this)">
                        <button onclick="document.getElementById('fileInput').click()" class="group flex items-center gap-2 bg-slate-50 hover:bg-senac-blue hover:text-white text-slate-600 px-4 py-2 rounded-xl border border-slate-200 transition-all shadow-sm" title="Carregar Dados Gerais.xlsm">
                            <i data-lucide="upload-cloud" class="w-4 h-4 text-senac-orange group-hover:text-white transition-colors"></i>
                            <span id="btnUploadText" class="text-xs font-bold uppercase">Carregar Dados</span>
                        </button>
                        <div id="loadingSpinner" class="hidden"><div class="loader border-t-senac-blue"></div></div>
                    </div>
                    
                    <button onclick="logout()" class="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-lg transition-colors" title="Sair / Trocar Usuário">
                        <i data-lucide="log-out" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Navegação (Tabs) -->
            <div class="flex px-8 bg-white gap-8 border-t border-slate-50">
                <button onclick="switchTab('qualificacao')" id="tabQualificacao" class="scope-btn active py-3 text-xs font-bold uppercase tracking-wide flex items-center gap-2">
                    <i data-lucide="book-open" class="w-4 h-4"></i>
                    Aprendizagem Qualificação
                </button>
                <button onclick="switchTab('tecnico')" id="tabTecnico" class="scope-btn py-3 text-xs font-bold uppercase tracking-wide flex items-center gap-2">
                    <i data-lucide="wrench" class="w-4 h-4"></i>
                    Aprendizagem Técnica
                </button>
                <button onclick="switchTab('financeiro')" id="tabFinanceiro" class="scope-btn py-3 text-xs font-bold uppercase tracking-wide flex items-center gap-2 text-emerald-600">
                    <i data-lucide="dollar-sign" class="w-4 h-4"></i>
                    Gestão Financeira
                </button>
            </div>
        </header>

        <!-- VIEWS -->
        <div class="flex-1 overflow-hidden relative">
            
            <!-- VIEW 1: DASHBOARD OPERACIONAL (Qualificação/Técnico) -->
            <div id="viewDashboard" class="flex h-full w-full">
                <!-- Sidebar Filtros -->
                <aside class="w-80 bg-white border-r border-slate-200 flex flex-col z-20 overflow-y-auto shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
                    <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                        <h3 class="font-bold text-slate-700 flex items-center gap-2 mb-5">
                            <div class="p-1.5 bg-white border border-slate-200 rounded-lg shadow-sm text-senac-orange">
                                <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                            </div>
                            Filtros Avançados
                        </h3>
                        
                        <div class="relative group mb-5">
                            <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-senac-blue transition-colors"></i>
                            <input type="text" id="filterSearch" onkeyup="applyFilters()" placeholder="Buscar Jovem ou Turma..." 
                                class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm focus:border-senac-blue focus:ring-4 focus:ring-blue-50 outline-none transition-all shadow-sm">
                        </div>

                        <div class="mb-6">
                            <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-1 block">Situação do Contrato</label>
                            <div class="relative">
                                <select id="filterContractStatus" onchange="applyFilters()" class="w-full appearance-none p-3 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:border-senac-blue focus:ring-2 focus:ring-blue-50 transition-all cursor-pointer text-slate-700 font-medium">
                                    <option value="active">Apenas Ativos (Padrão)</option>
                                    <option value="closed" class="text-red-600 font-bold">Apenas Encerrados</option>
                                    <option value="all">Todos (Ativos + Encerrados)</option>
                                </select>
                                <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-1 block">Região</label>
                                <div class="relative">
                                    <select id="filterRegiao" onchange="handleRegionChange()" class="w-full appearance-none p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-senac-blue focus:bg-white transition-all cursor-pointer text-slate-700 disabled:opacity-50 disabled:bg-slate-100">
                                        <option value="">Todas as Regiões</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                </div>
                                <p id="regionLockMsg" class="hidden text-[10px] text-senac-orange mt-1 font-bold flex items-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> Filtro bloqueado pelo perfil</p>
                            </div>
                            <div>
                                <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-1 block">Cidade</label>
                                <div class="relative">
                                    <select id="filterCidade" onchange="applyFilters()" class="w-full appearance-none p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-senac-blue focus:bg-white transition-all cursor-pointer text-slate-700">
                                        <option value="">Todas as Cidades</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6 mt-auto bg-slate-50 border-t border-slate-200">
                        <p class="text-[10px] font-bold text-slate-400 uppercase mb-3">Legenda de Situação</p>
                        <div class="space-y-2.5">
                            <div class="flex items-center gap-2.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.4)]"></div>
                                <span class="text-xs text-slate-600 font-medium">No Prazo / Realizada</span>
                            </div>
                            <div class="flex items-center gap-2.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.4)]"></div>
                                <span id="legendDelayedText" class="text-xs text-slate-600 font-medium">Atrasado (> 90 dias)</span>
                            </div>
                            <div class="flex items-center gap-2.5">
                                <div class="w-2.5 h-2.5 rounded-full bg-slate-400"></div>
                                <span class="text-xs text-slate-400">Encerrado</span>
                            </div>
                        </div>
                    </div>
                </aside>

                <!-- Conteúdo Principal Dashboard -->
                <main class="flex-1 flex flex-col overflow-hidden bg-slate-50/50 relative">
                    <!-- KPIs -->
                    <div class="p-6 pb-2 grid grid-cols-12 gap-6 h-auto flex-shrink-0">
                        <div class="col-span-12 lg:col-span-3 grid grid-cols-1 gap-4">
                            <div onclick="filterByStatus('all')" class="card-bi p-5 cursor-pointer relative overflow-hidden group border-l-4 border-l-senac-blue">
                                <div class="flex justify-between items-start z-10 relative">
                                    <div>
                                        <p class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mb-1">Total Visualizado</p>
                                        <h2 class="text-3xl font-extrabold text-slate-800 group-hover:text-senac-blue transition-colors" id="kpiTotal">0</h2>
                                    </div>
                                    <div class="p-2.5 bg-blue-50 text-senac-blue rounded-xl group-hover:scale-110 transition-transform">
                                        <i data-lucide="users" class="w-5 h-5"></i>
                                    </div>
                                </div>
                            </div>

                            <div onclick="filterByStatus('atrasado')" class="card-bi p-5 cursor-pointer relative overflow-hidden group border-l-4 border-l-red-500">
                                <div class="flex justify-between items-start z-10 relative">
                                    <div>
                                        <p class="text-[11px] text-red-400 font-bold uppercase tracking-wider mb-1">Visitas Atrasadas</p>
                                        <h2 class="text-3xl font-extrabold text-red-600" id="kpiAtrasados">0</h2>
                                        <p id="kpiDelayedText" class="text-[10px] text-red-400 mt-1 font-medium">Fora do prazo de 90 dias</p>
                                    </div>
                                    <div class="p-2.5 bg-red-50 text-red-500 rounded-xl group-hover:scale-110 transition-transform">
                                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                                    </div>
                                </div>
                            </div>
                            
                            <div onclick="filterByStatus('noprazo')" class="card-bi p-5 cursor-pointer relative overflow-hidden group border-l-4 border-l-emerald-500">
                                <div class="flex justify-between items-start z-10 relative">
                                    <div>
                                        <p class="text-[11px] text-emerald-500 font-bold uppercase tracking-wider mb-1">Em Dia</p>
                                        <h2 class="text-3xl font-extrabold text-emerald-600" id="kpiNoPrazo">0</h2>
                                    </div>
                                    <div class="p-2.5 bg-emerald-50 text-emerald-500 rounded-xl group-hover:scale-110 transition-transform">
                                        <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gráficos -->
                        <div class="col-span-12 md:col-span-4 lg:col-span-4 card-bi p-5 flex flex-col">
                            <h3 class="text-xs font-bold text-slate-600 uppercase mb-4 flex items-center gap-2">
                                <i data-lucide="pie-chart" class="w-4 h-4 text-senac-orange"></i> Status Geral
                            </h3>
                            <div class="flex-1 min-h-0 relative flex items-center justify-center">
                                <canvas id="chartStatus"></canvas>
                            </div>
                        </div>

                        <div class="col-span-12 md:col-span-5 lg:col-span-5 card-bi p-5 flex flex-col">
                            <h3 class="text-xs font-bold text-slate-600 uppercase mb-4 flex items-center gap-2">
                                <i data-lucide="bar-chart-2" class="w-4 h-4 text-senac-blue"></i> Top Cidades/Regiões
                            </h3>
                            <div class="flex-1 min-h-0 relative">
                                <canvas id="chartRegiao"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela -->
                    <div class="flex-1 px-6 pb-6 overflow-hidden flex flex-col">
                        <div class="card-bi flex-1 flex flex-col overflow-hidden bg-white">
                            <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl">
                                <div class="flex items-center gap-3">
                                    <div class="p-2 bg-slate-100 rounded-lg text-slate-600">
                                        <i data-lucide="list" class="w-4 h-4"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-slate-700 text-sm">Detalhamento dos Contratos</h3>
                                        <p class="text-xs text-slate-400 mt-0.5">Mostrando <strong id="countFiltered" class="text-senac-blue">0</strong> registros</p>
                                    </div>
                                </div>
                                
                                <div class="flex gap-2">
                                    <button onclick="exportFilteredReport()" class="flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-xs font-bold transition-all shadow-md shadow-emerald-200">
                                        <i data-lucide="download" class="w-4 h-4"></i> Baixar Relatório
                                    </button>
                                </div>
                            </div>

                            <div class="flex-1 overflow-auto custom-scrollbar">
                                <table class="w-full text-left border-collapse">
                                    <thead class="bg-slate-50 sticky top-0 z-10 text-[11px] uppercase text-slate-500 font-bold tracking-wide shadow-sm">
                                        <tr>
                                            <th class="p-4 w-[25%]">Jovem / Turma</th>
                                            <th class="p-4 w-[20%]">Empresa / Cidade</th>
                                            <th class="p-4 w-[20%]">Supervisor</th>
                                            <th class="p-4 w-[10%] text-center">Início/Fim</th>
                                            <th class="p-4 w-[15%] text-center">Situação Visitas</th>
                                            <th class="p-4 w-[10%] text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tableBody" class="divide-y divide-slate-100 text-sm">
                                        <tr>
                                            <td colspan="6" class="p-12 text-center text-slate-400">
                                                <div class="flex flex-col items-center gap-3">
                                                    <div class="w-16 h-16 bg-blue-50 text-senac-blue rounded-full flex items-center justify-center mb-2">
                                                        <i data-lucide="folder-open" class="w-8 h-8"></i>
                                                    </div>
                                                    <p class="text-sm font-bold text-slate-600">Aguardando dados...</p>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="p-3 border-t border-slate-100 flex justify-between items-center bg-slate-50 rounded-b-2xl px-6">
                                <span class="text-xs text-slate-500">Página <span id="pageDisplay" class="font-bold text-slate-700">1</span></span>
                                <div class="flex gap-2">
                                    <button onclick="changePage(-1)" class="px-3 py-1.5 border border-slate-200 rounded-lg hover:bg-white text-xs font-bold text-slate-600 disabled:opacity-50 transition-all shadow-sm" id="btnPrev">Anterior</button>
                                    <button onclick="changePage(1)" class="px-3 py-1.5 border border-slate-200 rounded-lg hover:bg-white text-xs font-bold text-slate-600 disabled:opacity-50 transition-all shadow-sm" id="btnNext">Próxima</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>

            <!-- VIEW 2: DASHBOARD FINANCEIRO (NOVO) -->
            <div id="viewFinanceiro" class="hidden h-full w-full bg-slate-50/50 flex-col overflow-auto p-8">
                
                <div class="max-w-7xl mx-auto w-full">
                    <div class="flex items-center justify-between mb-8">
                        <div>
                            <h2 class="text-2xl font-bold text-slate-800">Gestão Orçamentária de Visitas</h2>
                            <p class="text-sm text-slate-500">Comparativo de orçamento disponível versus estimativa de custos para visitas pendentes.</p>
                        </div>
                        <div class="bg-white p-2 rounded-xl shadow-sm border border-slate-200 flex items-center gap-2">
                            <span class="text-xs font-bold uppercase text-slate-400 px-2">Escopo Total:</span>
                            <span class="text-sm font-bold text-senac-blue">Qualificação + Técnico</span>
                        </div>
                    </div>

                    <!-- Painel de Inputs e KPIs -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        
                        <!-- Input: Orçamento -->
                        <div class="card-bi p-5 border-l-4 border-l-emerald-500">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Orçamento Disponível (R$)</label>
                            <input type="number" id="inputBudget" value="5000" class="money-input text-xl" oninput="updateFinancials()">
                            <p class="text-[10px] text-slate-400 mt-2">Valor total em caixa para o período.</p>
                        </div>

                        <!-- Input: Custo Médio -->
                        <div class="card-bi p-5 border-l-4 border-l-blue-500">
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Custo Estimado por Visita (R$)</label>
                            <input type="number" id="inputCost" value="85.50" class="money-input text-xl" oninput="updateFinancials()">
                            <p class="text-[10px] text-slate-400 mt-2">Média (Km + Diária/Refeição).</p>
                        </div>

                        <!-- KPI: Visitas Pendentes -->
                        <div class="card-bi p-5 flex flex-col justify-center">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Visitas Pendentes (Total)</p>
                                    <h3 class="text-3xl font-extrabold text-slate-700" id="finPendingVisits">0</h3>
                                </div>
                                <div class="p-3 bg-slate-100 rounded-full text-slate-500">
                                    <i data-lucide="calendar-clock" class="w-6 h-6"></i>
                                </div>
                            </div>
                        </div>

                        <!-- KPI: Custo Total Estimado -->
                        <div class="card-bi p-5 flex flex-col justify-center bg-slate-800 text-white border-none">
                            <div>
                                <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Custo Total Projetado</p>
                                <h3 class="text-3xl font-extrabold text-white" id="finProjectedCost">R$ 0,00</h3>
                            </div>
                        </div>
                    </div>

                    <!-- Gráfico e Saldo -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Card de Saldo -->
                        <div class="col-span-1 card-bi p-6 flex flex-col items-center justify-center text-center">
                            <p class="text-xs font-bold text-slate-400 uppercase mb-2">Saldo Projetado (Orçamento - Gastos)</p>
                            <h2 class="text-4xl font-extrabold mb-2" id="finBalance">R$ 0,00</h2>
                            <div id="finStatusBadge" class="px-4 py-1 rounded-full text-xs font-bold uppercase bg-slate-100 text-slate-500">
                                Aguardando Cálculo
                            </div>
                            <p class="text-xs text-slate-400 mt-4 max-w-[200px]">
                                Se negativo, o orçamento não cobrirá todas as visitas pendentes.
                            </p>
                        </div>

                        <!-- Gráfico Comparativo -->
                        <div class="col-span-2 card-bi p-5">
                            <h3 class="text-xs font-bold text-slate-600 uppercase mb-4">Comparativo Financeiro</h3>
                            <div class="h-64 w-full relative">
                                <canvas id="chartFinance"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela de Detalhamento por Região -->
                    <div class="card-bi overflow-hidden">
                        <div class="px-6 py-4 border-b border-slate-100 bg-slate-50/50">
                            <h3 class="font-bold text-slate-700 text-sm">Estimativa de Gastos por Região</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm">
                                <thead class="bg-white text-xs uppercase text-slate-500 font-bold border-b border-slate-100">
                                    <tr>
                                        <th class="p-4">Região / Cidade</th>
                                        <th class="p-4 text-center">Visitas Pendentes</th>
                                        <th class="p-4 text-right">Custo Estimado</th>
                                        <th class="p-4 text-center">% do Orçamento</th>
                                    </tr>
                                </thead>
                                <tbody id="finTableBody" class="divide-y divide-slate-100">
                                    <!-- Preenchido via JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT CENTRAL -->
    <script>
        // --- 0. VARIÁVEIS GLOBAIS ---
        let db = { qualificacao: [], tecnico: [] };
        let currentScope = 'qualificacao';
        
        // Configuração Financeira
        let financialChart = null;

        const PREDEFINED_REGIONS = [
            "APUCARANA", "CAMPO MOURÃO", "CASCAVEL", "CASTRO", "CORNÉLIO PROCÓPIO", "CURITIBA", 
            "FOZ DO IGUAÇU", "FRANCISCO BELTRÃO", "GUARAPUAVA", "IRATI", "IVAIPORÃ", 
            "JACAREZINHO", "LONDRINA", "MARINGÁ", "MATINHOS", "MEDIANEIRA", "PARANAGUÁ", 
            "PARANAVAÍ", "PATO BRANCO", "PONTA GROSSA", "PRUDENTÓPOLIS", "RIO NEGRO", 
            "SANTO ANTÔNIO DA PLATINA", "TOLEDO", "UMUARAMA", "UNIÃO DA VITÓRIA"
        ];

        const DEFAULT_USERS = [
            { name: 'Gestor Geral', region: '', email: 'gestor@senac.br' }
        ];

        let currentUser = null;
        let users = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let chartStatusInstance = null;
        let chartRegiaoInstance = null;
        let currentStatusFilter = 'all';

        // --- 1. LÓGICA DE ABAS (ESCOPO E FINANCEIRO) ---

        function switchTab(tabName) {
            const viewDash = document.getElementById('viewDashboard');
            const viewFin = document.getElementById('viewFinanceiro');
            
            // Resetar botões
            document.getElementById('tabQualificacao').classList.remove('active');
            document.getElementById('tabTecnico').classList.remove('active');
            document.getElementById('tabFinanceiro').classList.remove('active');

            if (tabName === 'financeiro') {
                document.getElementById('tabFinanceiro').classList.add('active');
                viewDash.classList.add('hidden');
                viewFin.classList.remove('hidden');
                viewFin.classList.add('flex');
                
                // Trigger finance update
                setTimeout(updateFinancials, 100);
            } else {
                currentScope = tabName;
                if(tabName === 'qualificacao') document.getElementById('tabQualificacao').classList.add('active');
                if(tabName === 'tecnico') document.getElementById('tabTecnico').classList.add('active');
                
                viewDash.classList.remove('hidden');
                viewFin.classList.add('hidden');
                viewFin.classList.remove('flex');

                const daysLabel = currentScope === 'tecnico' ? "120" : "90";
                const legendEl = document.getElementById('legendDelayedText');
                const kpiEl = document.getElementById('kpiDelayedText');
                if(legendEl) legendEl.innerText = `Atrasado (> ${daysLabel} dias)`;
                if(kpiEl) kpiEl.innerText = `Fora do prazo de ${daysLabel} dias`;

                currentPage = 1;
                populateFilters(); 
                applyFilters();
            }
        }

        // --- 2. GESTÃO FINANCEIRA ---

        function updateFinancials() {
            // 1. Coletar Inputs
            const budget = parseFloat(document.getElementById('inputBudget').value) || 0;
            const costPerVisit = parseFloat(document.getElementById('inputCost').value) || 0;

            // 2. Calcular Visitas Pendentes (Global: Quali + Tec)
            // Visita pendente = Status não contém "realizada"
            let totalPending = 0;
            let regionStats = {};

            const processList = (list) => {
                list.forEach(item => {
                    // Verifica se o contrato está ativo (opcional, mas recomendado)
                    const isEncerrado = item.fim && parseDate(item.fim) < new Date();
                    if (isEncerrado) return;

                    let pendingForStudent = 0;
                    item.visits.forEach(v => {
                        const status = (v.status || "").toLowerCase();
                        if (!status.includes("realizada") && !status.includes("concluída")) {
                            pendingForStudent++;
                        }
                    });

                    if (pendingForStudent > 0) {
                        totalPending += pendingForStudent;
                        
                        // Agrupar por Região (ou Cidade se Região for vazia)
                        const key = item.regiao || item.cidade || "Indefinido";
                        if (!regionStats[key]) regionStats[key] = 0;
                        regionStats[key] += pendingForStudent;
                    }
                });
            };

            processList(db.qualificacao || []);
            processList(db.tecnico || []);

            // 3. Cálculos
            const projectedCost = totalPending * costPerVisit;
            const balance = budget - projectedCost;

            // 4. Atualizar UI
            document.getElementById('finPendingVisits').innerText = totalPending;
            document.getElementById('finProjectedCost').innerText = formatCurrency(projectedCost);
            
            const elBalance = document.getElementById('finBalance');
            elBalance.innerText = formatCurrency(balance);
            elBalance.className = `text-4xl font-extrabold mb-2 ${balance >= 0 ? 'text-emerald-600' : 'text-red-600'}`;

            const elBadge = document.getElementById('finStatusBadge');
            if (balance >= 0) {
                elBadge.innerText = "Orçamento Suficiente";
                elBadge.className = "px-4 py-1 rounded-full text-xs font-bold uppercase bg-emerald-100 text-emerald-700";
            } else {
                elBadge.innerText = "Déficit Orçamentário";
                elBadge.className = "px-4 py-1 rounded-full text-xs font-bold uppercase bg-red-100 text-red-700";
            }

            // 5. Atualizar Gráfico
            updateFinancialChart(budget, projectedCost);

            // 6. Atualizar Tabela Regional
            updateFinancialTable(regionStats, costPerVisit, budget);
        }

        function formatCurrency(val) {
            return val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        function updateFinancialChart(budget, expenses) {
            const ctx = document.getElementById('chartFinance');
            if (!ctx) return;

            if (financialChart) financialChart.destroy();

            financialChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Orçamento Disponível', 'Gastos Projetados'],
                    datasets: [{
                        label: 'Valor (R$)',
                        data: [budget, expenses],
                        backgroundColor: [
                            '#10b981', // Emerald
                            expenses > budget ? '#ef4444' : '#3b82f6' // Red se estourar, Blue se ok
                        ],
                        borderRadius: 6,
                        barThickness: 60
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f1f5f9' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function updateFinancialTable(stats, costPerVisit, totalBudget) {
            const tbody = document.getElementById('finTableBody');
            tbody.innerHTML = '';

            // Converter objeto em array e ordenar por custo decrescente
            const rows = Object.entries(stats)
                .map(([region, visits]) => ({
                    region,
                    visits,
                    cost: visits * costPerVisit
                }))
                .sort((a, b) => b.cost - a.cost);

            if (rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-slate-400 text-xs">Nenhum dado pendente encontrado.</td></tr>`;
                return;
            }

            rows.forEach(row => {
                const percent = totalBudget > 0 ? (row.cost / totalBudget * 100).toFixed(1) : 0;
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50";
                tr.innerHTML = `
                    <td class="p-4 font-medium text-slate-700">${row.region}</td>
                    <td class="p-4 text-center text-slate-600 bg-slate-50">${row.visits}</td>
                    <td class="p-4 text-right font-bold text-slate-700">${formatCurrency(row.cost)}</td>
                    <td class="p-4 text-center">
                        <div class="flex items-center gap-2 justify-center">
                            <div class="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                                <div class="h-full bg-senac-blue" style="width: ${Math.min(percent, 100)}%"></div>
                            </div>
                            <span class="text-[10px] text-slate-500">${percent}%</span>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 3. INICIALIZAÇÃO E LOGIN (Padrão) ---

        function initUsers() {
            try {
                const stored = localStorage.getItem('senacSupervisors');
                if (stored && stored !== '[]') {
                    users = JSON.parse(stored);
                } else {
                    users = [...DEFAULT_USERS];
                    localStorage.setItem('senacSupervisors', JSON.stringify(users));
                }
            } catch (e) {
                console.warn("Erro no localStorage", e);
                users = [...DEFAULT_USERS];
            }
            populateLoginRegions();
        }

        function populateLoginRegions() {
            const loginSel = document.getElementById('loginRegion');
            let options = '';
            PREDEFINED_REGIONS.forEach(r => {
                options += `<option value="${r}">${r}</option>`;
            });
            if(loginSel) loginSel.innerHTML = '<option value="">Acesso Geral (Todas as Regiões)</option>' + options;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initUsers();
            if(typeof lucide !== 'undefined') lucide.createIcons();
        });

        function toggleLoginMethod() {
            const region = document.getElementById('loginRegion').value;
            const emailContainer = document.getElementById('emailContainer');
            const passwordContainer = document.getElementById('passwordContainer');

            if (region === "") { 
                emailContainer.classList.add('hidden');
                passwordContainer.classList.remove('hidden');
            } else { 
                emailContainer.classList.remove('hidden');
                passwordContainer.classList.add('hidden');
            }
        }

        function performLogin() {
            const region = document.getElementById('loginRegion').value;
            if (region === "") {
                const password = document.getElementById('loginPassword').value;
                if (password === "supervisao2026") {
                    currentUser = { name: "Gestão Central", region: "", email: "admin@senac.br" };
                    finishLogin();
                } else {
                    alert("Senha de acesso geral incorreta.");
                }
            } else {
                const email = document.getElementById('loginEmail').value.trim().toLowerCase();
                if (!email) return alert("Por favor, digite seu e-mail.");
                // Lógica simplificada de login regional
                currentUser = { name: "Supervisor Regional", region: region, email: email };
                finishLogin();
            }
        }

        function finishLogin() {
            const displayRegion = currentUser.region || "Acesso Geral";
            document.getElementById('displayUserName').innerText = currentUser.name;
            document.getElementById('displayUserRegion').innerText = displayRegion;
            
            // ANIMAÇÃO DE SAÍDA DO LOGIN
            const loginPage = document.getElementById('loginPage');
            loginPage.classList.add('transition-opacity', 'duration-500', 'opacity-0');
            setTimeout(() => {
                loginPage.style.display = 'none';
                
                // EXIBE O PAINEL PRINCIPAL
                const appContainer = document.getElementById('appContainer');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
                
            }, 500);
            
            if (displayRegion !== "Acesso Geral" && displayRegion !== "") {
                const filterReg = document.getElementById('filterRegiao');
                if (filterReg) {
                    filterReg.value = displayRegion;
                    filterReg.disabled = true; 
                    handleRegionChange(); 
                    document.getElementById('regionLockMsg').classList.remove('hidden');
                }
            }
            tryLoadDefault();
        }

        function logout() {
            window.location.reload();
        }

        function resetUsersToDefault() {
             localStorage.removeItem('senacSupervisors');
             window.location.reload();
        }

        // --- 4. PROCESSAMENTO DE ARQUIVOS (Excel) ---

        async function tryLoadDefault() {
            const spinner = document.getElementById('loadingSpinner');
            if(spinner) spinner.classList.remove('hidden');
            // Tentativa de carregar arquivo local padrão se existir no ambiente
            const candidates = ["Dados Gerais.xlsm", "Dados Gerais.xlsx", "dados gerais.xlsx"];
            let fileFound = false;

            for (const filename of candidates) {
                try {
                    const response = await fetch(filename);
                    if (response.ok) {
                        const blob = await response.blob();
                        const file = new File([blob], filename);
                        processFile({ files: [file] });
                        fileFound = true;
                        break; 
                    }
                } catch (e) { }
            }
            if (!fileFound && spinner) spinner.classList.add('hidden');
        }

        function processFile(input) {
            const file = input.files[0];
            if(!file) return;
            
            const spinner = document.getElementById('loadingSpinner');
            if(spinner) spinner.classList.remove('hidden');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                setTimeout(() => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // Busca abas flexíveis
                        let sheetQuali = workbook.SheetNames.find(n => n.trim().toLowerCase() === "dados gerais");
                        if(!sheetQuali) sheetQuali = workbook.SheetNames.find(n => n.toLowerCase().includes("dados gerais") && !n.toLowerCase().includes("tec"));
                        let sheetTec = workbook.SheetNames.find(n => n.toLowerCase().includes("dados gerais") && (n.toLowerCase().includes("tec") || n.toLowerCase().includes("téc")));
                        if(!sheetQuali && !sheetTec) sheetQuali = workbook.SheetNames[0];

                        db.qualificacao = [];
                        db.tecnico = [];

                        if (sheetQuali) db.qualificacao = parseSheet(workbook.Sheets[sheetQuali]);
                        if (sheetTec) db.tecnico = parseSheet(workbook.Sheets[sheetTec]);

                        switchTab(currentScope);
                        
                        if(spinner) spinner.classList.add('hidden');
                        const btnText = document.getElementById('btnUploadText');
                        if(btnText) btnText.innerText = "Atualizado";

                    } catch(e) {
                        console.error(e);
                        alert("Erro ao processar arquivo. Verifique o formato.");
                        if(spinner) spinner.classList.add('hidden');
                    }
                }, 100);
            };
            reader.readAsArrayBuffer(file);
        }

        function parseSheet(worksheet) {
            const json = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ""});
            if(json.length < 2) return [];
            const headers = json[0].map(h => String(h).trim());
            const getIdx = (candidates) => {
                for(let c of candidates) {
                    const i = headers.findIndex(h => h.toLowerCase().includes(c.toLowerCase()));
                    if(i > -1) return i;
                }
                return -1;
            }

            const map = {
                nome: getIdx(["Apr. Nome", "Nome", "Jovem"]),
                turma: getIdx(["Turma", "Matrícula"]),
                curso: getIdx(["Curso", "Nome do Curso"]), 
                hrTeoria: getIdx(["Teoria Hr Ini", "Horario Teoria"]),
                hrPratica: getIdx(["Horário do jovem", "Pratica Hr Ini"]),
                cidade: getIdx(["Emp. Cidade"]),
                regiao: getIdx(["Atuação Senac", "Região"]),
                empresa: getIdx(["Razao Social", "Empresa"]),
                supNome: getIdx(["Sup. Cadastrado", "Supervisor"]),
                supEmpresa: getIdx(["Sup. na Empresa"]),
                supCel: getIdx(["Sup Celular", "Contato"]),
                supEmail: getIdx(["Sup. Email", "Email Supervisor"]), 
                dtIni: getIdx(["TurDatIni"]),
                dtFim: getIdx(["TurDatFim"]),
                v1Dt: getIdx(["Data da Visita 1"]),
                v1St: getIdx(["Status Visita 1"]),
                v2Dt: getIdx(["Data da Visita 2"]),
                v2St: getIdx(["Status Visita"]), 
                v3Dt: getIdx(["Data da Visita 3"]),
                v3St: getIdx(["Status Visita"])
            };

            return json.slice(1).map((row, i) => {
                if(!row[map.nome]) return null;
                const idxV2St = map.v2Dt > -1 ? map.v2Dt + 1 : -1; 
                const idxV3St = map.v3Dt > -1 ? map.v3Dt + 1 : -1;
                return {
                    id: i,
                    nome: String(row[map.nome]).trim(),
                    turma: String(row[map.turma] || "N/A"),
                    cidade: row[map.cidade] || "N/A",
                    regiao: row[map.regiao] || "Geral",
                    empresa: row[map.empresa],
                    supervisor: {
                        nome: row[map.supNome] || "Não inf.",
                        cel: row[map.supCel] || "",
                        email: row[map.supEmail] || "" 
                    },
                    inicio: parseDate(row[map.dtIni]),
                    fim: parseDate(row[map.dtFim]),
                    visits: [
                        { date: parseDate(row[map.v1Dt]), status: String(row[map.v1St]).trim(), label: "1ª" },
                        { date: parseDate(row[map.v2Dt]), status: String(row[idxV2St] || row[map.v2St]).trim(), label: "2ª" },
                        { date: parseDate(row[map.v3Dt]), status: String(row[idxV3St] || row[map.v3St]).trim(), label: "3ª" }
                    ],
                    hrTeoria: formatExcelTime(row[map.hrTeoria]),
                    hrPratica: formatExcelTime(row[map.hrPratica])
                };
            }).filter(x => x);
        }

        // --- 5. HELPERS ---

        function parseDate(val) {
            if(!val) return null;
            if(val instanceof Date) return val;
            if(typeof val === 'number') {
                const date = new Date(Math.round((val - 25569)*86400*1000));
                return new Date(date.getTime() + date.getTimezoneOffset()*60000);
            }
            if(typeof val === 'string') {
                val = val.trim();
                if(val.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [y,m,d] = val.split('-'); return new Date(y, m-1, d);
                }
                if(val.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const [d,m,y] = val.split('/'); return new Date(y, m-1, d);
                }
            }
            return null;
        }

        function formatExcelTime(val) {
            if (!val) return "";
            if (typeof val === 'number') {
                const totalSeconds = Math.round(val * 86400);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
            return val;
        }

        function analyzeJovem(jovem) {
            const isEncerrado = jovem.fim && jovem.fim < new Date();
            let globalStatus = "No Prazo";
            let globalColor = "green"; 
            if (isEncerrado) return { ...jovem, processedVisits: jovem.visits, globalStatus: "Encerrado", globalColor: "gray", isEncerrado };

            let lastReferenceDate = jovem.inicio;
            let visitsDoneCount = 0;
            const processedVisits = jovem.visits.map(v => {
                let state = "pending";
                const isRealizada = v.status.toLowerCase().includes("realizada");
                if (isRealizada) {
                    state = "done";
                    visitsDoneCount++;
                    if (v.date) lastReferenceDate = v.date;
                }
                return { ...v, state };
            });

            if (visitsDoneCount === 3) return { ...jovem, processedVisits, globalStatus: "Concluído", globalColor: "blue", isEncerrado };
            if (!lastReferenceDate) return { ...jovem, processedVisits, globalStatus: "Sem Data Ini", globalColor: "gray", isEncerrado };

            const deadline = new Date(lastReferenceDate);
            const daysToAdd = currentScope === 'tecnico' ? 120 : 90;
            deadline.setDate(deadline.getDate() + daysToAdd);
            
            if (new Date() > deadline) { globalStatus = "Atrasado"; globalColor = "red"; }

            return { ...jovem, processedVisits, globalStatus, globalColor, isEncerrado };
        }

        // --- 6. RENDERIZAÇÃO DASHBOARD ---

        function populateFilters() {
            const selReg = document.getElementById('filterRegiao');
            if(!selReg) return;

            const currentData = db[currentScope] || [];
            const fileRegions = [...new Set(currentData.map(i => i.regiao))].filter(Boolean);
            const allRegions = [...new Set([...PREDEFINED_REGIONS, ...fileRegions])].sort();
            
            if (currentUser && currentUser.region) {
                selReg.innerHTML = `<option value="${currentUser.region}">${currentUser.region}</option>`;
                selReg.value = currentUser.region;
                selReg.disabled = true;
                const lockMsg = document.getElementById('regionLockMsg');
                if(lockMsg) lockMsg.classList.remove('hidden');
                updateCityOptions(currentUser.region); 
            } else {
                selReg.innerHTML = '<option value="">Todas as Regiões</option>';
                allRegions.forEach(r => selReg.innerHTML += `<option value="${r}">${r}</option>`);
                selReg.disabled = false;
                const lockMsg = document.getElementById('regionLockMsg');
                if(lockMsg) lockMsg.classList.add('hidden');
                updateCityOptions(""); 
            }
        }

        function handleRegionChange() {
            updateCityOptions(document.getElementById('filterRegiao').value);
            applyFilters();
        }

        function updateCityOptions(region) {
            const selCid = document.getElementById('filterCidade');
            if(!selCid) return;
            const currentVal = selCid.value;
            const currentData = db[currentScope] || [];

            const availableCities = [...new Set(
                currentData
                    .filter(item => region === "" || item.regiao === region)
                    .map(item => item.cidade)
            )].filter(Boolean).sort();

            selCid.innerHTML = '<option value="">Todas as Cidades</option>';
            availableCities.forEach(c => selCid.innerHTML += `<option value="${c}">${c}</option>`);
            if (availableCities.includes(currentVal)) selCid.value = currentVal;
        }

        function filterByStatus(status) {
            currentStatusFilter = status;
            applyFilters();
        }

        function applyFilters() {
            const search = document.getElementById('filterSearch').value.toLowerCase();
            const regiao = document.getElementById('filterRegiao').value;
            const cidade = document.getElementById('filterCidade').value;
            const contractStatus = document.getElementById('filterContractStatus').value;

            filteredData = (db[currentScope] || []).map(analyzeJovem).filter(item => {
                const nameMatch = item.nome && item.nome.toLowerCase().includes(search);
                const classMatch = item.turma && item.turma.toLowerCase().includes(search);
                if(search && !nameMatch && !classMatch) return false;
                if(regiao && item.regiao !== regiao) return false;
                if(cidade && item.cidade !== cidade) return false;
                if (contractStatus === 'active' && item.isEncerrado) return false;
                if (contractStatus === 'closed' && !item.isEncerrado) return false;
                if(currentStatusFilter === 'atrasado' && item.globalColor !== 'red') return false;
                if(currentStatusFilter === 'noprazo' && item.globalColor !== 'green' && item.globalColor !== 'blue') return false;
                return true;
            });

            updateDashboard();
            renderTable();
        }

        function updateDashboard() {
            const countEl = document.getElementById('countFiltered');
            if(countEl) countEl.innerText = filteredData.length;
            
            const total = filteredData.length;
            const atrasados = filteredData.filter(i => i.globalColor === 'red').length;
            const noPrazo = filteredData.filter(i => i.globalColor === 'green' || i.globalColor === 'blue').length;

            document.getElementById('kpiTotal').innerText = total;
            document.getElementById('kpiAtrasados').innerText = atrasados;
            document.getElementById('kpiNoPrazo').innerText = noPrazo;

            const ctxStatus = document.getElementById('chartStatus');
            if(ctxStatus) {
                if(chartStatusInstance) chartStatusInstance.destroy();
                const statusCounts = { 'No Prazo': 0, 'Atrasado': 0, 'Concluído': 0, 'Encerrado': 0 };
                filteredData.forEach(i => {
                    if(i.globalColor === 'green') statusCounts['No Prazo']++;
                    else if(i.globalColor === 'red') statusCounts['Atrasado']++;
                    else if(i.globalColor === 'blue') statusCounts['Concluído']++;
                    else statusCounts['Encerrado']++;
                });

                chartStatusInstance = new Chart(ctxStatus, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: ['#10b981', '#ef4444', '#004587', '#94a3b8'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, usePointStyle: true, font: {family: 'Inter'} } } } }
                });
            }

            const ctxRegiao = document.getElementById('chartRegiao');
            if(ctxRegiao) {
                if(chartRegiaoInstance) chartRegiaoInstance.destroy();
                const counts = {};
                const isRegiaoSelected = document.getElementById('filterRegiao').value !== "";
                filteredData.forEach(i => {
                    const key = isRegiaoSelected ? i.cidade : i.regiao;
                    counts[key] = (counts[key] || 0) + 1;
                });
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);

                chartRegiaoInstance = new Chart(ctxRegiao, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(x => x[0]),
                        datasets: [{
                            label: 'Jovens',
                            data: sorted.map(x => x[1]),
                            backgroundColor: '#004587',
                            borderRadius: 4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { grid: {display: false} }, y: { grid: {display: false} } } }
                });
            }
        }

        function changePage(delta) {
            currentPage += delta;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            if(!tbody) return;
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                 tbody.innerHTML = `<tr><td colspan="6" class="p-12 text-center text-slate-400">Nenhum registro encontrado.</td></tr>`;
                 return;
            }
            
            const totalPages = Math.ceil(filteredData.length / itemsPerPage) || 1;
            if (currentPage > totalPages) currentPage = 1;
            if (currentPage < 1) currentPage = 1;

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            document.getElementById('pageDisplay').innerText = `${currentPage} / ${totalPages}`;
            document.getElementById('btnPrev').disabled = currentPage === 1;
            document.getElementById('btnNext').disabled = currentPage === totalPages;

            const formatDate = (d) => d ? d.toLocaleDateString('pt-BR') : '-';

            pageData.forEach(item => {
                let visitsHtml = `<div class="flex gap-4 justify-center">`;
                item.processedVisits.forEach((v, idx) => {
                    let color = "bg-slate-200";
                    if(v.state === 'done') color = "bg-emerald-500 shadow-md shadow-emerald-200";
                    visitsHtml += `
                        <div class="flex flex-col items-center group relative cursor-help">
                            <div class="w-8 h-8 rounded-full ${color} flex items-center justify-center text-white text-xs font-bold border border-white">
                                ${idx + 1}
                            </div>
                        </div>
                    `;
                });
                visitsHtml += `</div>`;

                let badgeClass = "bg-slate-100 text-slate-500";
                if(item.globalColor === 'green') badgeClass = "bg-emerald-100 text-emerald-700 border border-emerald-200";
                if(item.globalColor === 'red') badgeClass = "bg-red-100 text-red-700 border border-red-200";
                if(item.globalColor === 'blue') badgeClass = "bg-blue-100 text-blue-700 border border-blue-200";

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50";
                tr.innerHTML = `
                    <td class="p-4 align-top">
                        <div class="font-bold text-slate-700 text-sm">${item.nome}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-mono bg-blue-50 text-blue-600 border border-blue-100">${item.turma}</span>
                            <span class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${item.hrTeoria}</span>
                        </div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-xs font-bold text-slate-700 truncate max-w-[150px]" title="${item.empresa}">${item.empresa}</div>
                        <div class="text-[10px] text-slate-400 mt-0.5 uppercase tracking-wide">${item.cidade}</div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-xs text-slate-600">
                            <div class="font-medium">${item.supervisor.nome}</div>
                            ${item.supervisor.cel ? `<div class="text-[10px] text-slate-400 flex items-center gap-1 mt-0.5"><i data-lucide="phone" class="w-2.5 h-2.5"></i> ${item.supervisor.cel}</div>` : ''}
                        </div>
                    </td>
                    <td class="p-4 align-top text-center text-xs font-mono text-slate-500">
                        <div class="text-emerald-600">${formatDate(item.inicio)}</div>
                        <div class="text-slate-400 border-l h-2 mx-auto my-0.5 w-px"></div>
                        <div class="${item.isEncerrado ? 'text-red-400 line-through' : ''}">${formatDate(item.fim)}</div>
                    </td>
                    <td class="p-4 align-top">
                        ${visitsHtml}
                    </td>
                    <td class="p-4 align-top text-center">
                        <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${badgeClass}">
                            ${item.globalStatus}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function exportFilteredReport() {
            if (filteredData.length === 0) return alert("Nenhum dado para exportar.");
            const formatDate = (d) => d ? d.toLocaleDateString('pt-BR') : '-';
            const exportData = [[
                "Nome do Jovem", "Turma", "Curso", "Horário", "Empresa", "Cidade", "Região",
                "Supervisor Senac", "Supervisor Empresa", "Celular Sup", "Email Sup",
                "Data Início", "Data Fim",
                "Status Geral"
            ]];
            filteredData.forEach(item => {
                exportData.push([
                    item.nome, item.turma, item.curso, item.hrTeoria, item.empresa, item.cidade, item.regiao,
                    item.supervisor.nome, item.supervisor.empresa, item.supervisor.cel, item.supervisor.email,
                    formatDate(item.inicio), formatDate(item.fim),
                    item.globalStatus
                ]);
            });
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Relatorio_${currentScope}`);
            XLSX.writeFile(wb, `Relatorio_Senac_${currentScope}.xlsx`);
        }
    </script>
</body>
</html>
