<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel BI - Supervisão Senac 2025</title>
    <!-- Bibliotecas Externas (CDNs) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        :root {
            --senac-blue: #004587;
            --senac-orange: #f68d2e;
            --senac-light-blue: #0056a3;
        }

        /* Classes Utilitárias Senac */
        .text-senac-blue { color: var(--senac-blue); }
        .text-senac-orange { color: var(--senac-orange); }
        .bg-senac-blue { background-color: var(--senac-blue); }
        .bg-senac-orange { background-color: var(--senac-orange); }
        
        .card-bi { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 4px 20px -2px rgba(0, 0, 0, 0.05); 
            border: 1px solid #e2e8f0; 
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card-bi:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        /* Modal de Login */
        #authModal {
            display: flex;
            backdrop-filter: blur(8px);
            background-color: rgba(255, 255, 255, 0.9);
        }

        /* Botões de Alternância de Escopo */
        .scope-btn {
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            opacity: 0.6;
        }
        .scope-btn.active {
            opacity: 1;
            border-bottom-color: var(--senac-orange);
            background-color: #f8fafc;
            color: var(--senac-blue);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Loader */
        .loader { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #f68d2e; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- MODAL DE ACESSO (Login) -->
    <div id="authModal" class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl border border-slate-200 w-full max-w-md p-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-senac-blue to-senac-orange"></div>
            
            <div class="text-center mb-8">
                <h2 class="text-2xl font-extrabold text-senac-blue">Portal do Supervisor</h2>
                <p class="text-sm text-slate-500 mt-1">Identifique-se para acessar os dados</p>
            </div>

            <!-- Formulário de Login -->
            <div id="loginForm">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Selecione seu Usuário</label>
                    <div class="relative">
                        <select id="userSelect" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl text-slate-700 font-medium outline-none focus:border-senac-blue focus:ring-2 focus:ring-blue-50 appearance-none cursor-pointer">
                            <option value="">Carregando usuários...</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                
                <button onclick="performLogin()" class="w-full py-3 bg-senac-blue hover:bg-blue-800 text-white font-bold rounded-xl transition-all shadow-lg shadow-blue-900/10 flex items-center justify-center gap-2">
                    <span>Acessar Painel</span>
                    <i data-lucide="arrow-right" class="w-4 h-4"></i>
                </button>

                <!-- Botões de Gerenciamento -->
                <div class="mt-6 flex justify-between items-center px-2">
                    <button onclick="toggleAddUser(true)" class="text-xs text-senac-orange font-bold hover:underline flex items-center gap-1">
                        <i data-lucide="plus-circle" class="w-3 h-3"></i> Manual (Navegador)
                    </button>
                    <button onclick="resetUsersToDefault()" class="text-[10px] text-slate-400 hover:text-red-500 hover:underline">
                        Restaurar Padrão
                    </button>
                </div>
                <p class="mt-4 text-[10px] text-slate-400 text-center px-4">
                    Dica: Adicione uma aba chamada <strong>"Usuarios"</strong> na sua planilha Dados Gerais para carregar a equipe automaticamente.
                </p>
            </div>

            <!-- Formulário Novo Usuário -->
            <div id="addUserForm" class="hidden">
                <h3 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
                    <i data-lucide="user-plus" class="w-4 h-4 text-senac-orange"></i> Novo Cadastro Local
                </h3>
                
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Nome</label>
                        <input type="text" id="newUserName" placeholder="Ex: João Silva" class="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-senac-blue">
                    </div>
                    
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">E-mail</label>
                        <input type="email" id="newUserEmail" placeholder="Ex: joao@senac.br" class="w-full p-2 border border-slate-200 rounded-lg text-sm outline-none focus:border-senac-blue">
                    </div>

                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase">Região de Atuação</label>
                        <div class="relative">
                            <select id="newUserRegion" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-white outline-none focus:border-senac-blue appearance-none">
                                <option value="">Acesso Geral (Todas as Regiões)</option>
                                <!-- Regiões populadas via JS -->
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-3 h-3 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>

                <div class="flex gap-2 mt-5">
                    <button onclick="toggleAddUser(false)" class="flex-1 py-2 bg-slate-100 text-slate-600 font-bold rounded-lg text-xs hover:bg-slate-200 transition-colors">Cancelar</button>
                    <button onclick="saveNewUser()" class="flex-1 py-2 bg-senac-orange text-white font-bold rounded-lg text-xs hover:bg-orange-600 transition-colors shadow-sm">Salvar Acesso</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 flex-shrink-0 z-30 shadow-sm flex flex-col">
        <!-- Top Bar -->
        <div class="h-16 flex items-center justify-between px-8">
            <div class="flex items-center gap-4">
                <div class="flex flex-col select-none">
                    <div class="flex items-baseline leading-none">
                        <span class="text-2xl font-extrabold text-senac-blue tracking-tight">Senac</span>
                    </div>
                    <div class="w-full h-1 bg-senac-orange mt-1 rounded-full"></div>
                </div>
                <div class="h-8 w-px bg-slate-200 mx-2"></div>
                <div>
                    <h1 class="font-bold text-sm text-slate-700">Painel de Supervisão</h1>
                    <p class="text-[10px] text-slate-400 font-medium uppercase tracking-wider">Gestão de Aprendizagem</p>
                </div>
            </div>

            <div class="flex items-center gap-6">
                <!-- Info Usuário -->
                <div class="text-right hidden md:block">
                    <p class="text-sm font-bold text-senac-blue" id="displayUserName">Visitante</p>
                    <p class="text-[10px] text-slate-400 font-mono" id="displayUserRegion">Acesso Restrito</p>
                </div>

                <!-- Botão Upload (Manual e Auto) -->
                <div class="flex items-center gap-2">
                    <input type="file" id="fileInput" accept=".csv, .xlsx, .xlsm, .xls" class="hidden" onchange="processFile(this)">
                    <button onclick="document.getElementById('fileInput').click()" class="group flex items-center gap-2 bg-slate-50 hover:bg-senac-blue hover:text-white text-slate-600 px-4 py-2 rounded-xl border border-slate-200 transition-all shadow-sm" title="Carregar Dados Gerais.xlsm">
                        <i data-lucide="upload-cloud" class="w-4 h-4 text-senac-orange group-hover:text-white transition-colors"></i>
                        <span id="btnUploadText" class="text-xs font-bold uppercase">Recarregar</span>
                    </button>
                    <div id="loadingSpinner" class="hidden"><div class="loader border-t-senac-blue"></div></div>
                </div>
                
                <button onclick="logout()" class="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-lg transition-colors" title="Sair / Trocar Usuário">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>

        <!-- Navegação de Curso (Tabs) -->
        <div class="flex px-8 bg-white gap-8 border-t border-slate-50">
            <button onclick="switchScope('qualificacao')" id="btnScopeQualificacao" class="scope-btn active py-3 text-xs font-bold uppercase tracking-wide flex items-center gap-2">
                <i data-lucide="book-open" class="w-4 h-4"></i>
                Aprendizagem Qualificação
            </button>
            <button onclick="switchScope('tecnico')" id="btnScopeTecnico" class="scope-btn py-3 text-xs font-bold uppercase tracking-wide flex items-center gap-2">
                <i data-lucide="wrench" class="w-4 h-4"></i>
                Aprendizagem Técnica
            </button>
        </div>
    </header>

    <div class="flex-1 flex overflow-hidden">
        
        <!-- Sidebar Filtros -->
        <aside class="w-80 bg-white border-r border-slate-200 flex flex-col z-20 overflow-y-auto shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <div class="p-6 border-b border-slate-100 bg-slate-50/50">
                <h3 class="font-bold text-slate-700 flex items-center gap-2 mb-5">
                    <div class="p-1.5 bg-white border border-slate-200 rounded-lg shadow-sm text-senac-orange">
                        <i data-lucide="sliders-horizontal" class="w-4 h-4"></i>
                    </div>
                    Filtros Avançados
                </h3>
                
                <!-- Busca -->
                <div class="relative group mb-5">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 group-focus-within:text-senac-blue transition-colors"></i>
                    <input type="text" id="filterSearch" onkeyup="applyFilters()" placeholder="Buscar Jovem ou Turma..." 
                           class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm focus:border-senac-blue focus:ring-4 focus:ring-blue-50 outline-none transition-all shadow-sm">
                </div>

                <!-- Filtro Situação do Contrato -->
                <div class="mb-6">
                    <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-1 block">Situação do Contrato</label>
                    <div class="relative">
                        <select id="filterContractStatus" onchange="applyFilters()" class="w-full appearance-none p-3 bg-white border border-slate-200 rounded-xl text-sm outline-none focus:border-senac-blue focus:ring-2 focus:ring-blue-50 transition-all cursor-pointer text-slate-700 font-medium">
                            <option value="active">Apenas Ativos (Padrão)</option>
                            <option value="closed" class="text-red-600 font-bold">Apenas Encerrados</option>
                            <option value="all">Todos (Ativos + Encerrados)</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>

                <!-- Dropdowns Dependentes -->
                <div class="space-y-4">
                    <div>
                        <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-1 block">Região</label>
                        <div class="relative">
                            <select id="filterRegiao" onchange="handleRegionChange()" class="w-full appearance-none p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-senac-blue focus:bg-white transition-all cursor-pointer text-slate-700 disabled:opacity-50 disabled:bg-slate-100">
                                <option value="">Todas as Regiões</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                        <p id="regionLockMsg" class="hidden text-[10px] text-senac-orange mt-1 font-bold flex items-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i> Filtro bloqueado pelo perfil</p>
                    </div>
                    <div>
                        <label class="text-[11px] font-bold text-slate-400 uppercase tracking-wide ml-1 mb-1 block">Cidade</label>
                        <div class="relative">
                            <select id="filterCidade" onchange="applyFilters()" class="w-full appearance-none p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm outline-none focus:border-senac-blue focus:bg-white transition-all cursor-pointer text-slate-700">
                                <option value="">Todas as Cidades</option>
                            </select>
                            <i data-lucide="chevron-down" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400 pointer-events-none"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Legenda -->
            <div class="p-6 mt-auto bg-slate-50 border-t border-slate-200">
                <p class="text-[10px] font-bold text-slate-400 uppercase mb-3">Legenda de Situação</p>
                <div class="space-y-2.5">
                    <div class="flex items-center gap-2.5">
                        <div class="w-2.5 h-2.5 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.4)]"></div>
                        <span class="text-xs text-slate-600 font-medium">No Prazo / Realizada</span>
                    </div>
                    <div class="flex items-center gap-2.5">
                        <div class="w-2.5 h-2.5 rounded-full bg-red-500 shadow-[0_0_8px_rgba(239,68,68,0.4)]"></div>
                        <span class="text-xs text-slate-600 font-medium">Atrasado (> 90 dias)</span>
                    </div>
                    <div class="flex items-center gap-2.5">
                        <div class="w-2.5 h-2.5 rounded-full bg-slate-400"></div>
                        <span class="text-xs text-slate-400">Encerrado</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Conteúdo Principal -->
        <main class="flex-1 flex flex-col overflow-hidden bg-slate-50/50 relative">
            
            <!-- Dashboard BI -->
            <div class="p-6 pb-2 grid grid-cols-12 gap-6 h-auto flex-shrink-0">
                
                <!-- KPIs -->
                <div class="col-span-12 lg:col-span-3 grid grid-cols-1 gap-4">
                    <div onclick="filterByStatus('all')" class="card-bi p-5 cursor-pointer relative overflow-hidden group border-l-4 border-l-senac-blue">
                        <div class="flex justify-between items-start z-10 relative">
                            <div>
                                <p class="text-[11px] text-slate-400 font-bold uppercase tracking-wider mb-1">Total Visualizado</p>
                                <h2 class="text-3xl font-extrabold text-slate-800 group-hover:text-senac-blue transition-colors" id="kpiTotal">0</h2>
                            </div>
                            <div class="p-2.5 bg-blue-50 text-senac-blue rounded-xl group-hover:scale-110 transition-transform">
                                <i data-lucide="users" class="w-5 h-5"></i>
                            </div>
                        </div>
                    </div>

                    <div onclick="filterByStatus('atrasado')" class="card-bi p-5 cursor-pointer relative overflow-hidden group border-l-4 border-l-red-500">
                        <div class="flex justify-between items-start z-10 relative">
                            <div>
                                <p class="text-[11px] text-red-400 font-bold uppercase tracking-wider mb-1">Visitas Atrasadas</p>
                                <h2 class="text-3xl font-extrabold text-red-600" id="kpiAtrasados">0</h2>
                                <p class="text-[10px] text-red-400 mt-1 font-medium">Fora do prazo de 90 dias</p>
                            </div>
                            <div class="p-2.5 bg-red-50 text-red-500 rounded-xl group-hover:scale-110 transition-transform">
                                <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div onclick="filterByStatus('noprazo')" class="card-bi p-5 cursor-pointer relative overflow-hidden group border-l-4 border-l-emerald-500">
                        <div class="flex justify-between items-start z-10 relative">
                            <div>
                                <p class="text-[11px] text-emerald-500 font-bold uppercase tracking-wider mb-1">Em Dia</p>
                                <h2 class="text-3xl font-extrabold text-emerald-600" id="kpiNoPrazo">0</h2>
                            </div>
                            <div class="p-2.5 bg-emerald-50 text-emerald-500 rounded-xl group-hover:scale-110 transition-transform">
                                <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="col-span-12 md:col-span-4 lg:col-span-4 card-bi p-5 flex flex-col">
                    <h3 class="text-xs font-bold text-slate-600 uppercase mb-4 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-4 h-4 text-senac-orange"></i> Status Geral
                    </h3>
                    <div class="flex-1 min-h-0 relative flex items-center justify-center">
                        <canvas id="chartStatus"></canvas>
                    </div>
                </div>

                <div class="col-span-12 md:col-span-5 lg:col-span-5 card-bi p-5 flex flex-col">
                    <h3 class="text-xs font-bold text-slate-600 uppercase mb-4 flex items-center gap-2">
                        <i data-lucide="bar-chart-2" class="w-4 h-4 text-senac-blue"></i> Top Cidades/Regiões
                    </h3>
                    <div class="flex-1 min-h-0 relative">
                        <canvas id="chartRegiao"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabela -->
            <div class="flex-1 px-6 pb-6 overflow-hidden flex flex-col">
                <div class="card-bi flex-1 flex flex-col overflow-hidden bg-white">
                    <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white rounded-t-2xl">
                        <div class="flex items-center gap-3">
                            <div class="p-2 bg-slate-100 rounded-lg text-slate-600">
                                <i data-lucide="list" class="w-4 h-4"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-slate-700 text-sm">Detalhamento dos Contratos</h3>
                                <p class="text-xs text-slate-400 mt-0.5">Mostrando <strong id="countFiltered" class="text-senac-blue">0</strong> registros</p>
                            </div>
                        </div>
                        
                        <button onclick="exportFilteredReport()" class="flex items-center gap-2 px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg text-xs font-bold transition-all shadow-md shadow-emerald-200">
                            <i data-lucide="download" class="w-4 h-4"></i> Baixar Relatório Filtrado
                        </button>
                    </div>

                    <div class="flex-1 overflow-auto custom-scrollbar">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 sticky top-0 z-10 text-[11px] uppercase text-slate-500 font-bold tracking-wide shadow-sm">
                                <tr>
                                    <th class="p-4 w-[25%]">Jovem / Turma</th>
                                    <th class="p-4 w-[20%]">Empresa / Cidade</th>
                                    <th class="p-4 w-[20%]">Supervisor</th>
                                    <th class="p-4 w-[10%] text-center">Início/Fim</th>
                                    <th class="p-4 w-[15%] text-center">Situação Visitas</th>
                                    <th class="p-4 w-[10%] text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-slate-100 text-sm">
                                <tr>
                                    <td colspan="6" class="p-12 text-center text-slate-400">
                                        <div class="flex flex-col items-center gap-3">
                                            <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center animate-pulse">
                                                <i data-lucide="cloud-download" class="w-8 h-8 opacity-40"></i>
                                            </div>
                                            <p>Aguardando Dados...</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="p-3 border-t border-slate-100 flex justify-between items-center bg-slate-50 rounded-b-2xl px-6">
                        <span class="text-xs text-slate-500">Página <span id="pageDisplay" class="font-bold text-slate-700">1</span></span>
                        <div class="flex gap-2">
                            <button onclick="changePage(-1)" class="px-3 py-1.5 border border-slate-200 rounded-lg hover:bg-white text-xs font-bold text-slate-600 disabled:opacity-50 transition-all shadow-sm" id="btnPrev">Anterior</button>
                            <button onclick="changePage(1)" class="px-3 py-1.5 border border-slate-200 rounded-lg hover:bg-white text-xs font-bold text-slate-600 disabled:opacity-50 transition-all shadow-sm" id="btnNext">Próxima</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- SCRIPT CENTRAL -->
    <script>
        // --- 0. VARIÁVEIS GLOBAIS ---
        
        // Armazena os dados separadamente
        let db = {
            qualificacao: [],
            tecnico: []
        };
        
        // Define qual aba está ativa (padrão: qualificacao)
        let currentScope = 'qualificacao';

        // LISTA DE REGIÕES CONHECIDAS
        const PREDEFINED_REGIONS = [
            "APUCARANA", "CAMPO MOURÃO", "CASCAVEL", "CASTRO", "CORNÉLIO PROCÓPIO", "CURITIBA", 
            "FOZ DO IGUAÇU", "FRANCISCO BELTRÃO", "GUARAPUAVA", "IRATI", "IVAIPORÃ", 
            "JACAREZINHO", "LONDRINA", "MARINGÁ", "MATINHOS", "MEDIANEIRA", "PARANAGUÁ", 
            "PARANAVAÍ", "PATO BRANCO", "PONTA GROSSA", "PRUDENTÓPOLIS", "RIO NEGRO", 
            "SANTO ANTÔNIO DA PLATINA", "TOLEDO", "UMUARAMA", "UNIÃO DA VITÓRIA"
        ];

        // Usuários Padrão
        const DEFAULT_USERS = [
            { name: 'Gestor Geral', region: '', email: 'gestor@senac.br' },
            { name: 'Luciano', region: 'CAMPO MOURÃO', email: 'luciano.ramos@docente.pr.senac.br' },
            { name: 'Samoel', region: 'FRANCISCO BELTRÃO', email: 'samoel.pitz@docente.pr.senac.br' },
            { name: 'Michelly', region: 'GUARAPUAVA', email: 'michelly.gronkoski@docente.pr.senac.br' }
        ];

        let currentUser = null;
        let users = [];

        // Filtros e Paginação
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let chartStatusInstance = null;
        let chartRegiaoInstance = null;
        let currentStatusFilter = 'all';

        // --- 1. FUNÇÕES DE ESCOPO (Alternância de Abas) ---

        function switchScope(scope) {
            currentScope = scope;
            
            // Atualiza visual dos botões
            document.getElementById('btnScopeQualificacao').classList.toggle('active', scope === 'qualificacao');
            document.getElementById('btnScopeTecnico').classList.toggle('active', scope === 'tecnico');

            // Feedback visual se estiver vazio
            if (db[scope].length === 0) {
                // Se o array estiver vazio, talvez o arquivo ainda não foi carregado ou a aba não existe
                // Mas não damos erro aqui, apenas aplicamos os filtros que vão mostrar "0 registros" ou tabela vazia
            }

            // Reseta filtros básicos e reaplica
            currentPage = 1;
            populateFilters(); // Recarrega cidades/regiões baseadas no novo dataset
            applyFilters();
        }

        // --- 2. INICIALIZAÇÃO ---

        function initUsers() {
            try {
                const stored = localStorage.getItem('senacSupervisors');
                if (stored && stored !== '[]') {
                    users = JSON.parse(stored);
                } else {
                    users = [...DEFAULT_USERS];
                    localStorage.setItem('senacSupervisors', JSON.stringify(users));
                }
            } catch (e) {
                console.warn("Erro no localStorage, usando padrão", e);
                users = [...DEFAULT_USERS];
            }
            populateUserSelect();
        }

        function populateUserSelect() {
            const sel = document.getElementById('userSelect');
            if (!sel) return;
            sel.innerHTML = '<option value="">-- Selecione seu Usuário --</option>';
            users.forEach((u, index) => {
                sel.innerHTML += `<option value="${index}">${u.name} ${u.region ? `(${u.region})` : '- Geral'}</option>`;
            });
        }

        function resetUsersToDefault() {
            if(confirm("Tem certeza? Isso apagará usuários cadastrados manualmente neste navegador.")) {
                users = [...DEFAULT_USERS];
                localStorage.setItem('senacSupervisors', JSON.stringify(users));
                populateUserSelect();
                alert("Lista restaurada para o padrão do sistema.");
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initUsers();
            if(typeof lucide !== 'undefined') lucide.createIcons();
            const dateEl = document.getElementById('currentDate');
            if(dateEl) dateEl.innerText = new Date().toLocaleDateString('pt-BR');
        });

        function performLogin() {
            const sel = document.getElementById('userSelect');
            if(!sel) return;
            const idx = sel.value;
            if (idx === "") return alert("Por favor, selecione seu usuário na lista.");
            
            currentUser = users[idx];
            
            const nameEl = document.getElementById('displayUserName');
            const regEl = document.getElementById('displayUserRegion');
            
            if(nameEl) nameEl.innerText = currentUser.name;
            if(regEl) regEl.innerText = currentUser.region || "Acesso Geral";
            
            const modal = document.getElementById('authModal');
            if(modal) modal.style.display = 'none'; 
            
            tryLoadDefault();
        }

        function logout() {
            window.location.reload();
        }

        function toggleAddUser(show) {
            const loginForm = document.getElementById('loginForm');
            const addUserForm = document.getElementById('addUserForm');
            if(loginForm) loginForm.classList.toggle('hidden', show);
            if(addUserForm) addUserForm.classList.toggle('hidden', !show);
            if (show) populateNewUserRegions();
        }

        function saveNewUser() {
            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim();
            const region = document.getElementById('newUserRegion').value;

            if (!name) return alert("Preencha o nome do usuário");

            users.push({ name, email, region });
            localStorage.setItem('senacSupervisors', JSON.stringify(users));
            
            populateUserSelect();
            toggleAddUser(false);
            const sel = document.getElementById('userSelect');
            sel.value = users.length - 1;
            alert(`Usuário ${name} cadastrado com sucesso neste navegador!`);
        }

        function populateNewUserRegions() {
            const regSel = document.getElementById('newUserRegion');
            if(!regSel) return;
            // Pega regiões de AMBOS os datasets para popular o cadastro
            const allRaw = [...db.qualificacao, ...db.tecnico];
            const fileRegions = [...new Set(allRaw.map(r => r.regiao))].filter(Boolean);
            const allRegions = [...new Set([...PREDEFINED_REGIONS, ...fileRegions])].sort();

            let options = '<option value="">Acesso Geral (Todas as Regiões)</option>';
            allRegions.forEach(r => {
                options += `<option value="${r}">${r}</option>`;
            });
            regSel.innerHTML = options;
        }

        // --- 3. CARREGAMENTO DE ARQUIVOS (Lógica Atualizada) ---

        async function tryLoadDefault() {
            const spinner = document.getElementById('loadingSpinner');
            if(spinner) spinner.classList.remove('hidden');

            const candidates = ["Dados Gerais.xlsm", "Dados Gerais.xlsx", "dados gerais.xlsx", "Dados Gerais.csv"];
            let fileFound = false;

            for (const filename of candidates) {
                try {
                    const response = await fetch(filename);
                    if (response.ok) {
                        const blob = await response.blob();
                        const file = new File([blob], filename);
                        const dummyInput = { files: [file] };
                        processFile(dummyInput);
                        fileFound = true;
                        break; 
                    }
                } catch (e) {
                    console.log(`Tentativa falhou para ${filename}`);
                }
            }

            if (!fileFound) {
                console.warn("Nenhum arquivo padrão encontrado.");
                if(spinner) spinner.classList.add('hidden');
                
                const tbody = document.getElementById('tableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="p-12 text-center text-slate-400">
                                <div class="flex flex-col items-center gap-3">
                                    <div class="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center">
                                        <i data-lucide="file-warning" class="w-8 h-8 text-senac-orange"></i>
                                    </div>
                                    <p class="text-sm font-bold">Planilha não encontrada automaticamente.</p>
                                    <p class="text-xs">Verifique se o arquivo <strong>Dados Gerais.xlsm</strong> está na mesma pasta.</p>
                                    <button onclick="document.getElementById('fileInput').click()" class="mt-2 text-xs bg-senac-blue text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-blue-800 transition-colors">
                                        Selecionar Arquivo Manualmente
                                    </button>
                                </div>
                            </td>
                        </tr>`;
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                }
            }
        }

        function processFile(input) {
            const file = input.files[0];
            if(!file) return;
            
            const spinner = document.getElementById('loadingSpinner');
            if(spinner) spinner.classList.remove('hidden');
            
            const reader = new FileReader();
            
            reader.onload = function(e) {
                setTimeout(() => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        
                        // 1. Processar Usuários (Aba 'Usuarios' ou 'Login')
                        const userSheetName = workbook.SheetNames.find(n => 
                            n.toLowerCase().trim() === "usuarios" || 
                            n.toLowerCase().trim() === "usuários" ||
                            n.toLowerCase().trim() === "login"
                        );

                        if (userSheetName) {
                            const userWs = workbook.Sheets[userSheetName];
                            const userJson = XLSX.utils.sheet_to_json(userWs);
                            const loadedUsers = userJson.map(row => {
                                const getVal = (keys) => {
                                    for(let k of keys) {
                                        const key = Object.keys(row).find(rk => rk.toLowerCase().trim() === k.toLowerCase());
                                        if(key) return row[key];
                                    }
                                    return '';
                                };
                                return {
                                    name: getVal(['Nome', 'Usuario', 'User']),
                                    email: getVal(['Email', 'E-mail', 'Mail']),
                                    region: getVal(['Regiao', 'Região', 'Regional'])
                                };
                            }).filter(u => u.name);

                            if (loadedUsers.length > 0) {
                                users = loadedUsers;
                                localStorage.setItem('senacSupervisors', JSON.stringify(users));
                                populateUserSelect();
                            }
                        }

                        // 2. Processar "Dados Gerais" (Qualificação)
                        // Procura exato "Dados Gerais" ou algo muito parecido
                        let sheetQuali = workbook.SheetNames.find(n => n.trim().toLowerCase() === "dados gerais");
                        // Se não achar exato, pega a primeira que contiver "Gerais" e NÃO contiver "Tec"
                        if(!sheetQuali) sheetQuali = workbook.SheetNames.find(n => n.toLowerCase().includes("dados gerais") && !n.toLowerCase().includes("tec"));
                        
                        // 3. Processar "Dados Gerais - Téc" (Técnico)
                        // Procura algo que tenha "Gerais" E "Tec" ou "Téc"
                        let sheetTec = workbook.SheetNames.find(n => n.toLowerCase().includes("dados gerais") && (n.toLowerCase().includes("tec") || n.toLowerCase().includes("téc")));
                        
                        // Fallback: se não achar 'Dados Gerais' padrão, usa a primeira aba como Qualificação
                        if(!sheetQuali && !sheetTec) sheetQuali = workbook.SheetNames[0];

                        // Reset DB
                        db.qualificacao = [];
                        db.tecnico = [];

                        if (sheetQuali) {
                            console.log("Carregando Qualificação de:", sheetQuali);
                            db.qualificacao = parseSheet(workbook.Sheets[sheetQuali]);
                        }
                        
                        if (sheetTec) {
                            console.log("Carregando Técnico de:", sheetTec);
                            db.tecnico = parseSheet(workbook.Sheets[sheetTec]);
                        } else {
                            console.log("Aba Técnica não encontrada.");
                        }

                        // Atualiza a interface
                        switchScope(currentScope); // Mantém o escopo atual ou recarrega
                        
                        if(spinner) spinner.classList.add('hidden');
                        const btnText = document.getElementById('btnUploadText');
                        if(btnText) btnText.innerText = "Atualizado";

                    } catch(e) {
                        console.error(e);
                        alert("Erro ao processar arquivo.");
                        if(spinner) spinner.classList.add('hidden');
                    }
                }, 100);
            };
            reader.readAsArrayBuffer(file);
        }

        // Função genérica para ler uma aba e retornar array formatado
        function parseSheet(worksheet) {
            const json = XLSX.utils.sheet_to_json(worksheet, {header: 1, defval: ""});
            if(json.length < 2) return [];

            const headers = json[0].map(h => String(h).trim());
            
            const getIdx = (candidates) => {
                for(let c of candidates) {
                    const i = headers.findIndex(h => h.toLowerCase().includes(c.toLowerCase()));
                    if(i > -1) return i;
                }
                return -1;
            }

            const map = {
                nome: getIdx(["Apr. Nome", "Nome", "Jovem"]),
                turma: getIdx(["Turma", "Matrícula"]),
                hrTeoria: getIdx(["Teoria Hr Ini", "Horario Teoria"]),
                cidade: getIdx(["Emp. Cidade"]),
                regiao: getIdx(["Atuação Senac", "Região"]),
                empresa: getIdx(["Razao Social", "Empresa"]),
                supNome: getIdx(["Sup. Cadastrado", "Supervisor"]),
                supCel: getIdx(["Sup Celular"]),
                supEmail: getIdx(["Sup. Email", "Email Supervisor", "E-mail"]), 
                dtIni: getIdx(["TurDatIni"]),
                dtFim: getIdx(["TurDatFim"]),
                v1Dt: getIdx(["Data da Visita 1"]),
                v1St: getIdx(["Status Visita 1"]),
                v2Dt: getIdx(["Data da Visita 2"]),
                v2St: getIdx(["Status Visita"]), 
                v3Dt: getIdx(["Data da Visita 3"]),
                v3St: getIdx(["Status Visita"])
            };

            return json.slice(1).map((row, i) => {
                if(!row[map.nome]) return null;
                
                // Ajuste para colunas de status subsequentes se não nomeadas explicitamente
                const idxV2St = map.v2Dt > -1 ? map.v2Dt + 1 : -1; 
                const idxV3St = map.v3Dt > -1 ? map.v3Dt + 1 : -1;

                return {
                    id: i,
                    nome: String(row[map.nome]).trim(),
                    turma: String(row[map.turma] || "N/A"),
                    hrTeoria: formatExcelTime(row[map.hrTeoria]), 
                    cidade: row[map.cidade] || "N/A",
                    regiao: row[map.regiao] || "Geral",
                    empresa: row[map.empresa],
                    supervisor: {
                        nome: row[map.supNome] || "Não inf.",
                        cel: row[map.supCel] || "",
                        email: row[map.supEmail] || "" 
                    },
                    inicio: parseDate(row[map.dtIni]),
                    fim: parseDate(row[map.dtFim]),
                    visits: [
                        { date: parseDate(row[map.v1Dt]), status: String(row[map.v1St]).trim(), label: "1ª" },
                        { date: parseDate(row[map.v2Dt]), status: String(row[idxV2St] || row[map.v2St]).trim(), label: "2ª" },
                        { date: parseDate(row[map.v3Dt]), status: String(row[idxV3St] || row[map.v3St]).trim(), label: "3ª" }
                    ]
                };
            }).filter(x => x);
        }

        // --- Helpers ---
        function parseDate(val) {
            if(!val) return null;
            if(val instanceof Date) return val;
            if(typeof val === 'number') {
                const date = new Date(Math.round((val - 25569)*86400*1000));
                return new Date(date.getTime() + date.getTimezoneOffset()*60000);
            }
            if(typeof val === 'string') {
                val = val.trim();
                if(val.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [y,m,d] = val.split('-'); return new Date(y, m-1, d);
                }
                if(val.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    const [d,m,y] = val.split('/'); return new Date(y, m-1, d);
                }
            }
            return null;
        }

        function formatExcelTime(val) {
            if (!val) return "-";
            if (typeof val === 'number') {
                const totalSeconds = Math.round(val * 86400);
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
            }
            return val;
        }

        function analyzeJovem(jovem) {
            const isEncerrado = jovem.fim && jovem.fim < new Date();
            let globalStatus = "No Prazo";
            let globalColor = "green"; 
            
            if (isEncerrado) {
                return { ...jovem, processedVisits: jovem.visits, globalStatus: "Encerrado", globalColor: "gray", isEncerrado };
            }

            let lastReferenceDate = jovem.inicio;
            let visitsDoneCount = 0;

            const processedVisits = jovem.visits.map(v => {
                let state = "pending";
                const isRealizada = v.status.toLowerCase().includes("realizada");
                if (isRealizada) {
                    state = "done";
                    visitsDoneCount++;
                    if (v.date) lastReferenceDate = v.date;
                }
                return { ...v, state };
            });

            if (visitsDoneCount === 3) {
                globalStatus = "Concluído";
                globalColor = "blue";
                return { ...jovem, processedVisits, globalStatus, globalColor, isEncerrado };
            }

            if (!lastReferenceDate) {
                globalStatus = "Sem Data Ini";
                globalColor = "gray";
                return { ...jovem, processedVisits, globalStatus, globalColor, isEncerrado };
            }

            const deadline = new Date(lastReferenceDate);
            deadline.setDate(deadline.getDate() + 90);
            
            const today = new Date();
            if (today > deadline) {
                globalStatus = "Atrasado";
                globalColor = "red";
            } else {
                globalStatus = "No Prazo";
                globalColor = "green";
            }

            return { ...jovem, processedVisits, globalStatus, globalColor, isEncerrado };
        }

        // --- FILTROS E RENDERIZAÇÃO ---

        function populateFilters() {
            const selReg = document.getElementById('filterRegiao');
            if(!selReg) return;

            // Pega dados do escopo atual para os filtros
            const currentData = db[currentScope] || [];

            // Une regiões predefinidas com as do arquivo atual
            const fileRegions = [...new Set(currentData.map(i => i.regiao))].filter(Boolean);
            const allRegions = [...new Set([...PREDEFINED_REGIONS, ...fileRegions])].sort();
            
            if (currentUser && currentUser.region) {
                selReg.innerHTML = `<option value="${currentUser.region}">${currentUser.region}</option>`;
                selReg.value = currentUser.region;
                selReg.disabled = true;
                const lockMsg = document.getElementById('regionLockMsg');
                if(lockMsg) lockMsg.classList.remove('hidden');
                updateCityOptions(currentUser.region); 
            } else {
                selReg.innerHTML = '<option value="">Todas as Regiões</option>';
                allRegions.forEach(r => selReg.innerHTML += `<option value="${r}">${r}</option>`);
                selReg.disabled = false;
                const lockMsg = document.getElementById('regionLockMsg');
                if(lockMsg) lockMsg.classList.add('hidden');
                updateCityOptions(""); 
            }
        }

        function handleRegionChange() {
            const el = document.getElementById('filterRegiao');
            if(el) {
                updateCityOptions(el.value);
                applyFilters();
            }
        }

        function updateCityOptions(region) {
            const selCid = document.getElementById('filterCidade');
            if(!selCid) return;
            const currentVal = selCid.value;
            const currentData = db[currentScope] || [];

            const availableCities = [...new Set(
                currentData
                    .filter(item => region === "" || item.regiao === region)
                    .map(item => item.cidade)
            )].filter(Boolean).sort();

            selCid.innerHTML = '<option value="">Todas as Cidades</option>';
            availableCities.forEach(c => selCid.innerHTML += `<option value="${c}">${c}</option>`);
            
            if (availableCities.includes(currentVal)) {
                selCid.value = currentVal;
            }
        }

        function filterByStatus(status) {
            currentStatusFilter = status;
            applyFilters();
        }

        function applyFilters() {
            const searchEl = document.getElementById('filterSearch');
            const regEl = document.getElementById('filterRegiao');
            const cidEl = document.getElementById('filterCidade');
            const statusEl = document.getElementById('filterContractStatus');

            if(!searchEl || !regEl || !cidEl || !statusEl) return;

            // Usa os dados do escopo atual
            const rawData = db[currentScope] || [];

            const search = searchEl.value.toLowerCase();
            const regiao = regEl.value;
            const cidade = cidEl.value;
            const contractStatus = statusEl.value;

            filteredData = rawData.map(analyzeJovem).filter(item => {
                const nameMatch = item.nome && item.nome.toLowerCase().includes(search);
                const classMatch = item.turma && item.turma.toLowerCase().includes(search);
                if(search && !nameMatch && !classMatch) return false;
                
                if(regiao && item.regiao !== regiao) return false;
                if(cidade && item.cidade !== cidade) return false;

                if (contractStatus === 'active') {
                    if (item.isEncerrado) return false;
                } else if (contractStatus === 'closed') {
                    if (!item.isEncerrado) return false;
                }

                if(currentStatusFilter === 'atrasado' && item.globalColor !== 'red') return false;
                if(currentStatusFilter === 'noprazo' && item.globalColor !== 'green' && item.globalColor !== 'blue') return false;

                return true;
            });

            // Se o dataset estiver vazio (ex: aba técnica não existe), filteredData será vazio
            // A tabela mostrará "0 registros", o que é correto.

            updateDashboard();
            renderTable();
        }

        function updateDashboard() {
            const countEl = document.getElementById('countFiltered');
            if(countEl) countEl.innerText = filteredData.length;
            
            const total = filteredData.length;
            const atrasados = filteredData.filter(i => i.globalColor === 'red').length;
            const noPrazo = filteredData.filter(i => i.globalColor === 'green' || i.globalColor === 'blue').length;

            const kpiTotal = document.getElementById('kpiTotal');
            const kpiAtrasados = document.getElementById('kpiAtrasados');
            const kpiNoPrazo = document.getElementById('kpiNoPrazo');

            if(kpiTotal) kpiTotal.innerText = total;
            if(kpiAtrasados) kpiAtrasados.innerText = atrasados;
            if(kpiNoPrazo) kpiNoPrazo.innerText = noPrazo;

            const ctxStatus = document.getElementById('chartStatus');
            if(ctxStatus) {
                if(chartStatusInstance) chartStatusInstance.destroy();
                
                const statusCounts = { 'No Prazo': 0, 'Atrasado': 0, 'Concluído': 0, 'Encerrado': 0 };
                filteredData.forEach(i => {
                    if(i.globalColor === 'green') statusCounts['No Prazo']++;
                    else if(i.globalColor === 'red') statusCounts['Atrasado']++;
                    else if(i.globalColor === 'blue') statusCounts['Concluído']++;
                    else statusCounts['Encerrado']++;
                });

                chartStatusInstance = new Chart(ctxStatus, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(statusCounts),
                        datasets: [{
                            data: Object.values(statusCounts),
                            backgroundColor: ['#10b981', '#ef4444', '#004587', '#94a3b8'],
                            borderWidth: 0,
                            hoverOffset: 10
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        cutout: '70%',
                        plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, usePointStyle: true, font: {family: 'Inter'} } } } 
                    }
                });
            }

            const ctxRegiao = document.getElementById('chartRegiao');
            if(ctxRegiao) {
                if(chartRegiaoInstance) chartRegiaoInstance.destroy();

                const counts = {};
                const isRegiaoSelected = document.getElementById('filterRegiao').value !== "";
                
                filteredData.forEach(i => {
                    const key = isRegiaoSelected ? i.cidade : i.regiao;
                    counts[key] = (counts[key] || 0) + 1;
                });
                
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);

                chartRegiaoInstance = new Chart(ctxRegiao, {
                    type: 'bar',
                    data: {
                        labels: sorted.map(x => x[0]),
                        datasets: [{
                            label: 'Jovens',
                            data: sorted.map(x => x[1]),
                            backgroundColor: '#004587',
                            borderRadius: 4
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        indexAxis: 'y', 
                        plugins: { legend: { display: false } }, 
                        scales: { x: { grid: {display: false} }, y: { grid: {display: false} } } 
                    }
                });
            }
        }

        function changePage(delta) {
            currentPage += delta;
            renderTable();
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            if(!tbody) return;
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                 tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="p-12 text-center text-slate-400">
                            <div class="flex flex-col items-center gap-3">
                                <i data-lucide="inbox" class="w-8 h-8 opacity-40"></i>
                                <p>Nenhum dado encontrado para o filtro atual.</p>
                            </div>
                        </td>
                    </tr>`;
                 if(typeof lucide !== 'undefined') lucide.createIcons();
                 return;
            }
            
            const totalPages = Math.ceil(filteredData.length / itemsPerPage) || 1;
            if (currentPage > totalPages) currentPage = 1;
            if (currentPage < 1) currentPage = 1;

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = filteredData.slice(start, end);

            const pageDisplay = document.getElementById('pageDisplay');
            const btnPrev = document.getElementById('btnPrev');
            const btnNext = document.getElementById('btnNext');

            if(pageDisplay) pageDisplay.innerText = `${currentPage} / ${totalPages}`;
            if(btnPrev) btnPrev.disabled = currentPage === 1;
            if(btnNext) btnNext.disabled = currentPage === totalPages;

            const formatDate = (d) => d ? d.toLocaleDateString('pt-BR') : '-';

            pageData.forEach(item => {
                let visitsHtml = `<div class="flex gap-4 justify-center">`;
                item.processedVisits.forEach((v, idx) => {
                    let color = "bg-slate-200";
                    if(v.state === 'done') color = "bg-emerald-500 shadow-md shadow-emerald-200";
                    
                    const dateDisplay = v.date ? `<div class="text-[9px] text-slate-500 mt-1 font-mono">${formatDate(v.date)}</div>` : `<div class="text-[9px] text-slate-300 mt-1 font-mono">-</div>`;

                    visitsHtml += `
                        <div class="flex flex-col items-center group relative cursor-help">
                            <div class="w-8 h-8 rounded-full ${color} flex items-center justify-center text-white text-xs font-bold border border-white">
                                ${idx + 1}
                            </div>
                            ${dateDisplay}
                            <div class="absolute bottom-full mb-2 hidden group-hover:block bg-slate-800 text-white text-[10px] p-2 rounded shadow-lg z-50 whitespace-nowrap">
                                <strong>${v.label}</strong><br>
                                Data: ${formatDate(v.date)}<br>
                                Status: ${v.status}
                            </div>
                        </div>
                    `;
                });
                visitsHtml += `</div>`;

                let badgeClass = "bg-slate-100 text-slate-500";
                if(item.globalColor === 'green') badgeClass = "bg-emerald-100 text-emerald-700 border border-emerald-200";
                if(item.globalColor === 'red') badgeClass = "bg-red-100 text-red-700 border border-red-200";
                if(item.globalColor === 'blue') badgeClass = "bg-blue-100 text-blue-700 border border-blue-200";

                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-50 transition-colors border-b border-slate-50";
                tr.innerHTML = `
                    <td class="p-4 align-top">
                        <div class="font-bold text-slate-700 text-sm">${item.nome}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="px-1.5 py-0.5 rounded text-[10px] font-mono bg-blue-50 text-blue-600 border border-blue-100">${item.turma}</span>
                            <span class="text-xs text-slate-400 flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> ${item.hrTeoria}</span>
                        </div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-xs font-bold text-slate-700 truncate max-w-[150px]" title="${item.empresa}">${item.empresa}</div>
                        <div class="text-[10px] text-slate-400 mt-0.5 uppercase tracking-wide">${item.cidade}</div>
                    </td>
                    <td class="p-4 align-top">
                        <div class="text-xs text-slate-600">
                            <div class="font-medium">${item.supervisor.nome}</div>
                            ${item.supervisor.cel ? `<div class="text-[10px] text-slate-400 flex items-center gap-1 mt-0.5"><i data-lucide="phone" class="w-2.5 h-2.5"></i> ${item.supervisor.cel}</div>` : ''}
                             ${item.supervisor.email ? `<div class="text-[10px] text-slate-400 flex items-center gap-1 mt-0.5 truncate max-w-[150px]" title="${item.supervisor.email}"><i data-lucide="mail" class="w-2.5 h-2.5"></i> ${item.supervisor.email}</div>` : ''}
                        </div>
                    </td>
                    <td class="p-4 align-top text-center text-xs font-mono text-slate-500">
                        <div class="text-emerald-600">${formatDate(item.inicio)}</div>
                        <div class="text-slate-400 border-l h-2 mx-auto my-0.5 w-px"></div>
                        <div class="${item.isEncerrado ? 'text-red-400 line-through' : ''}">${formatDate(item.fim)}</div>
                    </td>
                    <td class="p-4 align-top">
                        ${visitsHtml}
                    </td>
                    <td class="p-4 align-top text-center">
                        <span class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wide ${badgeClass}">
                            ${item.globalStatus}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function exportFilteredReport() {
            if (filteredData.length === 0) return alert("Nenhum dado para exportar.");
            const formatDate = (d) => d ? d.toLocaleDateString('pt-BR') : '-';
            const exportData = [[
                "Nome do Jovem", "Turma", "Horário", "Empresa", "Cidade", "Região",
                "Supervisor", "Celular Sup", "Email Sup",
                "Data Início", "Data Fim",
                "Status Geral", 
                "Data V1", "Status V1",
                "Data V2", "Status V2",
                "Data V3", "Status V3"
            ]];
            filteredData.forEach(item => {
                const v1 = item.processedVisits[0];
                const v2 = item.processedVisits[1];
                const v3 = item.processedVisits[2];
                exportData.push([
                    item.nome, item.turma, item.hrTeoria, item.empresa, item.cidade, item.regiao,
                    item.supervisor.nome, item.supervisor.cel, item.supervisor.email,
                    formatDate(item.inicio), formatDate(item.fim),
                    item.globalStatus,
                    formatDate(v1.date), v1.status,
                    formatDate(v2.date), v2.status,
                    formatDate(v3.date), v3.status
                ]);
            });
            const ws = XLSX.utils.aoa_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Relatorio_${currentScope}`);
            XLSX.writeFile(wb, `Relatorio_Senac_${currentScope}_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.xlsx`);
        }
    </script>
</body>
</html>
